#!/usr/bin/env python3
# SCons helper script
# ===================

import os
import sys
import argparse
import subprocess

# Add site_scons to path for imports
sys.path.insert(0, os.path.join(os.path.dirname(__file__), 'site_scons'))

def print_usage():
    """Print usage information."""
    print(f"""
Integral Philosophy Publishing System - SCons Helper Script
=========================================================

Usage: {sys.argv[0]} [COMMAND] [OPTIONS]

Commands:
  init            Initialize SCons build system
  configure       Configure the project
  build           Build the project
  test            Run tests
  clean           Clean build artifacts
  help            Show this help
  info            Show build information

Examples:
  {sys.argv[0]} init                    # Initialize build system
  {sys.argv[0]} build --debug          # Build with debug flags
  {sys.argv[0]} test --verbose         # Run tests with verbose output
  {sys.argv[0]} clean                   # Clean everything

For more information, run: scons help
""")

def run_command(cmd, description="", check=True):
    """Run a command with error handling."""
    print(f"üîß {description}...")
    try:
        result = subprocess.run(cmd, shell=True, check=check, capture_output=True, text=True)
        if result.stdout:
            print(result.stdout)
        return result.returncode == 0
    except subprocess.CalledProcessError as e:
        print(f"‚ùå Error: {e}")
        if e.stderr:
            print(f"Error output: {e.stderr}")
        return False
    except Exception as e:
        print(f"‚ùå Exception: {e}")
        return False

def init_scons():
    """Initialize SCons build system."""
    print("üöÄ Initializing SCons build system...")
    
    # Check if SCons is installed
    if not run_command("scons --version", "Checking SCons installation"):
        print("‚ùå SCons not found. Please install SCons:")
        print("   Ubuntu/Debian: sudo apt-get install scons")
        print("   macOS: brew install scons")
        print("   pip: pip install scons")
        return False
    
    # Check for required files
    required_files = ['SConstruct', 'SConscript']
    missing_files = []
    
    for file_name in required_files:
        if not os.path.exists(file_name):
            missing_files.append(file_name)
    
    if missing_files:
        print(f"‚ùå Missing required files: {', '.join(missing_files)}")
        return False
    
    print("‚úÖ SCons build system initialized")
    return True

def configure_project(args):
    """Configure the project."""
    print("‚öôÔ∏è Configuring project...")
    
    # Build scons command with options
    cmd_parts = ["scons"]
    
    if args.debug:
        cmd_parts.append("DEBUG=1")
    
    if args.verbose:
        cmd_parts.append("VERBOSE=1")
    
    if args.profile:
        cmd_parts.append("PROFILE=1")
    
    if hasattr(args, 'test_file') and args.test_file:
        cmd_parts.append(f"TEST_FILE={args.test_file}")
    
    cmd = " ".join(cmd_parts)
    
    # Run configuration check
    return run_command(f"{cmd} verify", "Verifying configuration")

def build_project(args):
    """Build the project."""
    print("üî® Building project...")
    
    # Build scons command with options
    cmd_parts = ["scons"]
    
    if args.debug:
        cmd_parts.append("DEBUG=1")
    
    if args.verbose:
        cmd_parts.append("VERBOSE=1")
    
    if args.profile:
        cmd_parts.append("PROFILE=1")
    
    if args.dependencies:
        cmd_parts.insert(1, "deps")
    
    cmd = " ".join(cmd_parts)
    return run_command(cmd, "Building project")

def run_tests(args):
    """Run tests."""
    print("üß™ Running tests...")
    
    # Build scons command
    cmd_parts = ["scons"]
    
    if args.verbose:
        cmd_parts.append("VERBOSE=1")
    
    if args.test_type == "all":
        cmd_parts.append("check")
    elif args.test_type == "basic":
        cmd_parts.append("test")
    elif args.test_type == "validation":
        cmd_parts.append("validate")
    elif args.test_type == "analysis":
        cmd_parts.append("analyze")
    else:
        cmd_parts.append("check")
    
    cmd = " ".join(cmd_parts)
    return run_command(cmd, f"Running {args.test_type} tests")

def clean_project(args):
    """Clean build artifacts."""
    print("üßπ Cleaning build artifacts...")
    
    if args.all:
        cmd = "scons -c"
        description = "Cleaning all build artifacts"
    else:
        cmd = "scons clean"
        description = "Cleaning build artifacts"
    
    return run_command(cmd, description)

def show_info():
    """Show build information."""
    print("üìã Showing build information...")
    return run_command("scons info", "Getting build information")

def main():
    """Main function."""
    parser = argparse.ArgumentParser(
        description="SCons helper script for Integral Philosophy Publishing System",
        formatter_class=argparse.RawDescriptionHelpFormatter
    )
    
    subparsers = parser.add_subparsers(dest='command', help='Available commands')
    
    # Common arguments
    common_parser = argparse.ArgumentParser(add_help=False)
    common_parser.add_argument('--verbose', '-v', action='store_true', help='Verbose output')
    common_parser.add_argument('--debug', action='store_true', help='Enable debug mode')
    common_parser.add_argument('--profile', action='store_true', help='Enable profiling')
    
    # Init command
    init_parser = subparsers.add_parser('init', help='Initialize SCons build system')
    
    # Configure command
    config_parser = subparsers.add_parser('configure', help='Configure project', parents=[common_parser])
    config_parser.add_argument('--test-file', help='Specify test file')
    
    # Build command
    build_parser = subparsers.add_parser('build', help='Build project', parents=[common_parser])
    build_parser.add_argument('--dependencies', '-d', action='store_true', help='Install dependencies first')
    
    # Test command
    test_parser = subparsers.add_parser('test', help='Run tests', parents=[common_parser])
    test_parser.add_argument('--type', choices=['all', 'basic', 'validation', 'analysis'], 
                           default='all', dest='test_type', help='Type of tests to run')
    
    # Clean command
    clean_parser = subparsers.add_parser('clean', help='Clean build artifacts')
    clean_parser.add_argument('--all', '-a', action='store_true', help='Clean all artifacts including cache')
    
    # Info command
    info_parser = subparsers.add_parser('info', help='Show build information')
    
    # Help command
    help_parser = subparsers.add_parser('help', help='Show help')
    
    # Parse arguments
    args = parser.parse_args()
    
    # Handle commands
    if args.command == 'init' or not args.command:
        print_usage()
        return init_scons()
    elif args.command == 'configure':
        return configure_project(args)
    elif args.command == 'build':
        return build_project(args)
    elif args.command == 'test':
        return run_tests(args)
    elif args.command == 'clean':
        return clean_project(args)
    elif args.command == 'info':
        return show_info()
    elif args.command == 'help':
        print_usage()
        return True
    else:
        print(f"‚ùå Unknown command: {args.command}")
        print_usage()
        return False

if __name__ == '__main__':
    success = main()
    sys.exit(0 if success else 1)