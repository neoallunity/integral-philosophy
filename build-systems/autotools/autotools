#!/bin/bash
# Autotools helper script for Integral Philosophy Publishing System
# ==============================================================

# This script provides common autotools maintenance commands

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$SCRIPT_DIR"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

print_usage() {
    echo "Integral Philosophy Publishing System - Autotools Helper"
    echo "Usage: $0 [COMMAND]"
    echo ""
    echo "Commands:"
    echo "  bootstrap      - Run bootstrap script (initialize autotools)"
    echo "  configure      - Run configure script"
    echo "  clean          - Clean build artifacts"
    echo "  distclean      - Clean all generated files"
    echo "  dist           - Create distribution tarball"
    echo "  install        - Install the project"
    echo "  uninstall      - Uninstall the project"
    echo "  check          - Run tests and checks"
    echo "  help           - Show this help message"
    echo ""
    echo "Examples:"
    echo "  $0 bootstrap                    # Initialize build system"
    echo "  $0 configure --enable-debug     # Configure with debug"
    echo "  $0 check                       # Run all tests"
}

run_bootstrap() {
    echo "üöÄ Running bootstrap..."
    cd "$PROJECT_DIR"
    ./bootstrap
}

run_configure() {
    echo "‚öôÔ∏è Running configure with: $*"
    cd "$PROJECT_DIR"
    
    if [ ! -f "configure" ]; then
        echo -e "${YELLOW}Warning: configure script not found. Running bootstrap first...${NC}"
        ./bootstrap
    fi
    
    ./configure "$@"
}

run_clean() {
    echo "üßπ Cleaning build artifacts..."
    cd "$PROJECT_DIR"
    
    if [ -f "Makefile" ]; then
        make clean
    else
        echo -e "${YELLOW}No Makefile found. Run configure first.${NC}"
    fi
}

run_distclean() {
    echo "üßπ Cleaning all generated files..."
    cd "$PROJECT_DIR"
    
    if [ -f "Makefile" ]; then
        make distclean
    else
        echo -e "${YELLOW}No Makefile found. Running distclean manually...${NC}"
        rm -rf build-aux autom4te.cache
        rm -f configure aclocal.m4 config.log config.status
        rm -f Makefile Makefile.in src/Makefile src/Makefile.in
        rm -f build-aux/Makefile build-aux/Makefile.in
    fi
}

run_dist() {
    echo "üì¶ Creating distribution tarball..."
    cd "$PROJECT_DIR"
    
    if [ -f "Makefile" ]; then
        make dist
    else
        echo -e "${RED}No Makefile found. Run configure first.${NC}"
        exit 1
    fi
}

run_install() {
    echo "üì¶ Installing project..."
    cd "$PROJECT_DIR"
    
    if [ -f "Makefile" ]; then
        make install
    else
        echo -e "${RED}No Makefile found. Run configure first.${NC}"
        exit 1
    fi
}

run_uninstall() {
    echo "üóëÔ∏è Uninstalling project..."
    cd "$PROJECT_DIR"
    
    if [ -f "Makefile" ]; then
        make uninstall
    else
        echo -e "${RED}No Makefile found.${NC}"
        exit 1
    fi
}

run_check() {
    echo "üß™ Running tests and checks..."
    cd "$PROJECT_DIR"
    
    if [ -f "Makefile" ]; then
        make check
    else
        echo -e "${RED}No Makefile found. Run configure first.${NC}"
        exit 1
    fi
}

# Main script logic
case "${1:-}" in
    bootstrap)
        run_bootstrap
        ;;
    configure)
        shift
        run_configure "$@"
        ;;
    clean)
        run_clean
        ;;
    distclean)
        run_distclean
        ;;
    dist)
        run_dist
        ;;
    install)
        run_install
        ;;
    uninstall)
        run_uninstall
        ;;
    check)
        run_check
        ;;
    help|--help|-h)
        print_usage
        ;;
    "")
        print_usage
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        echo ""
        print_usage
        exit 1
        ;;
esac